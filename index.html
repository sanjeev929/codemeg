<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <title>AI Social Media Content Generators</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>

    <header>
        <h1>AI Social Media Content Generator</h1>
        <p>Generate Bio, Caption & Username instantly! No sign-in required.</p>
    </header>

    <main>
        <section class="generator">

            <!-- Custom Dropdown -->
            <div class="custom-dropdown" id="dropdown">
                <div class="dropdown-selected" id="dropdownSelected">
                    Bio Generator
                </div>

                <div class="dropdown-options" id="dropdownOptions">
                    <div data-value="bio">Bio Generator</div>
                    <div data-value="caption">Caption Generator</div>
                    <div data-value="username">Username Generator</div>
                </div>
            </div>

            <textarea id="prompt" placeholder="Type something..."></textarea>

            <button id="generate-btn">Generate</button>

            <div id="result-section">
                <h2>Result</h2>
                <div id="result"></div>
                <button id="save-btn">Save</button>
                <button id="copy-btn">Copy</button>
            </div>
        </section>

        <section class="saved">
            <h2>Saved Items</h2>
            <ul id="saved-list"></ul>
            <button id="clear-saved">Clear All</button>
        </section>
    </main>

    <script>
(function () {
  const HIDE_PAGE = true; // set false to show message instead of blank page
  const MESSAGE = "<h2 style='color:white;text-align:center;margin-top:40vh;font-family:Arial,Helvetica,sans-serif;'>This site is not available in Private / Incognito Mode.</h2>";

  // Immediately hide body to avoid flicker; will restore if not incognito
  const styleEl = document.createElement('style');
  styleEl.id = 'incognito-hide-style';
  styleEl.textContent = 'html{visibility:hidden !important;}';
  document.documentElement.prepend(styleEl);

  // Helpers
  function revealPage() {
    const el = document.getElementById('incognito-hide-style');
    if (el) el.remove();
  }
  function killPageDisplay() {
    // Clear all content and set black background
    document.open();
    if (HIDE_PAGE) {
      document.write('');
    } else {
      document.write("<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'></head><body style='margin:0;background:#000;'>" + MESSAGE + "</body></html>");
    }
    document.close();
  }

  // Multi-heuristic detection (returns Promise<boolean>)
  async function detectIncognito() {
    // 1) Try quick synchronous localStorage/cookie test
    try {
      const TEST_KEY = '__ig_test__';
      localStorage.setItem(TEST_KEY, TEST_KEY);
      localStorage.removeItem(TEST_KEY);
      // localStorage ok â€” not conclusive, continue
    } catch (e) {
      // localStorage blocked â€” strong signal for private
      return true;
    }

    // 2) Try IndexedDB open (async)
    let idbBlocked = false;
    try {
      await new Promise((resolve, reject) => {
        const req = indexedDB.open('__ig_idb_test__');
        let finished = false;
        req.onsuccess = () => {
          try { req.result.close(); indexedDB.deleteDatabase('__ig_idb_test__'); } catch(e){}
          if (!finished) { finished = true; resolve(); }
        };
        req.onerror = () => { if (!finished) { finished = true; reject(); } };
        // fallback timeout
        setTimeout(() => { if (!finished) { finished = true; reject(); } }, 1200);
      });
    } catch (e) {
      idbBlocked = true;
    }
    if (idbBlocked) return true; // strong signal

    // 3) Storage Estimate (quota very low in incognito)
    try {
      if (navigator.storage && navigator.storage.estimate) {
        const est = await navigator.storage.estimate();
        if (typeof est.quota === 'number') {
          // thresholds: incognito quotas vary; treat < 120MB as private (adjustable)
          if (est.quota < 120 * 1024 * 1024) return true;
        }
      }
    } catch (e) {
      // ignore
    }

    // 4) FileSystem API heuristic (webkitRequestFileSystem)
    try {
      const fs = window.RequestFileSystem || window.webkitRequestFileSystem;
      if (fs) {
        const fsRes = await new Promise((resolve) => {
          try {
            fs(window.TEMPORARY, 100, () => resolve(false), () => resolve(true));
          } catch (err) { resolve(false); }
        });
        if (fsRes) return true;
      }
    } catch (e) {}

    // 5) ServiceWorker / persistent storage attempt (optional)
    try {
      if (navigator.storage && navigator.storage.persist) {
        const persisted = await navigator.storage.persisted();
        // If persisted() throws or returns false often in incognito - no certainty, skip strong decision
        // We don't treat this alone as conclusive.
      }
    } catch (e) {}

    // If none were conclusive, assume not incognito
    return false;
  }

  // Run detection and act based on result
  (async function () {
    try {
      const isIncog = await detectIncognito();
      if (isIncog) {
        killPageDisplay();
      } else {
        revealPage();
      }
    } catch (err) {
      // If detection errored unexpectedly, reveal page to avoid locking out users
      revealPage();
    }
  })();

})();


 
/* ============================================
   DAILY LIMIT USING LOCALSTORAGE (FRONTEND)
   ============================================ */
const DAILY_LIMIT = 6;

function getToday() {
    return new Date().toISOString().split("T")[0];
}

function getRequestCount() {
    const data = JSON.parse(localStorage.getItem("limit_data"));

    if (!data || data.date !== getToday()) {
        localStorage.setItem("limit_data", JSON.stringify({ date: getToday(), count: 0 }));
        return 0;
    }
    return data.count;
}

function incrementRequestCount() {
    let data = JSON.parse(localStorage.getItem("limit_data")) || {};
    data.date = getToday();
    data.count = (data.count || 0) + 1;
    localStorage.setItem("limit_data", JSON.stringify(data));
}

function getRemainingRequests() {
    return DAILY_LIMIT - getRequestCount();
}

/* ============================================
   SHOW REMAINING REQUESTS LIVE
   ============================================ */
const header = document.querySelector("header");
const remainingBox = document.createElement("p");
remainingBox.id = "remaining-count";
remainingBox.style.marginTop = "10px";
remainingBox.style.fontWeight = "600";
updateRemainingDisplay();
header.appendChild(remainingBox);

function updateRemainingDisplay() {
    remainingBox.textContent = `Requests Left Today: ${getRemainingRequests()}`;
}

/* ============================================
   DROPDOWN LOGIC
   ============================================ */
const dropdown = document.getElementById("dropdown");
const dropdownSelected = document.getElementById("dropdownSelected");
const dropdownOptions = document.getElementById("dropdownOptions");
let selectedTool = "bio";

dropdownSelected.addEventListener("click", () => {
    dropdownOptions.classList.toggle("show");
});

dropdownOptions.querySelectorAll("div").forEach(option => {
    option.addEventListener("click", () => {
        dropdownSelected.textContent = option.textContent;
        selectedTool = option.getAttribute("data-value");
        dropdownOptions.classList.remove("show");
    });
});

document.addEventListener("click", (e) => {
    if (!dropdown.contains(e.target)) {
        dropdownOptions.classList.remove("show");
    }
});

/* ============================================
   MAIN UI ELEMENTS
   ============================================ */
const generateBtn = document.getElementById('generate-btn');
const saveBtn = document.getElementById('save-btn');
const copyBtn = document.getElementById('copy-btn');
const resultDiv = document.getElementById('result');
const savedList = document.getElementById('saved-list');
const clearSavedBtn = document.getElementById('clear-saved');
const promptInput = document.getElementById('prompt');

// Load saved items
let savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');
updateSavedList();

/* ============================================
   GENERATE BUTTON â€” API + LIMIT CHECK
   ============================================ */
generateBtn.addEventListener('click', async () => {
    const prompt = promptInput.value.trim();
    if (!prompt) return alert("Please enter a prompt");

    if (getRequestCount() >= DAILY_LIMIT) {
        alert("Daily limit reached! Come back tomorrow ðŸ˜Š");
        return;
    }

    generateBtn.disabled = true;
    const originalText = generateBtn.textContent;
    generateBtn.innerHTML = `<span class="loader"></span> Generating...`;

    try {
        const response = await fetch(`https://bio-gen.onrender.com/${selectedTool}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: "include",
            body: JSON.stringify({ prompt: prompt, history: [] })
        });

        const data = await response.json();
        if (!response.ok) return alert(data.detail || "API error");

        let text = data.result || "";
        text = text.replace(/\*\*/g, "").replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1");

        incrementRequestCount();
        updateRemainingDisplay();

        resultDiv.textContent = text;

    } catch (err) {
        alert("API error");
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = originalText;
    }
});

/* ============================================
   SAVE RESULT WITH COPY + DELETE BUTTONS
   ============================================ */
saveBtn.addEventListener('click', () => {
    const text = resultDiv.textContent.trim();
    if (!text) return;

    savedItems.push(text);
    localStorage.setItem('savedItems', JSON.stringify(savedItems));
    updateSavedList();
});

// Save button animation
document.getElementById("save-btn").addEventListener("click", function () {
    const btn = this;
    btn.textContent = "Saved";
    btn.style.opacity = "0.7";
    setTimeout(() => {
        btn.textContent = "Save";
        btn.style.opacity = "1";
    }, 1500);
});

/* ============================================
   COPY RESULT
   ============================================ */
copyBtn.addEventListener('click', () => {
    const text = resultDiv.textContent.trim();
    if (!text) return;

    navigator.clipboard.writeText(text);
});

/* ============================================
   CLEAR SAVED LIST
   ============================================ */
clearSavedBtn.addEventListener('click', () => {
    savedItems = [];
    localStorage.removeItem('savedItems');
    updateSavedList();
});

/* ============================================
   UPDATE SAVED LIST UI (WITH ANIMATED COPY + DELETE)
   ============================================ */
function updateSavedList() {
    savedList.innerHTML = "";

    savedItems.forEach((item, index) => {
        const li = document.createElement("li");
        li.className = "saved-item";

        const textDiv = document.createElement("span");
        textDiv.textContent = item;

        // Create button container
        const btnRow = document.createElement("div");
        btnRow.className = "saved-item-buttons";

        /* COPY button */
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copy";
        copyBtn.className = "small-btn";
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(item);

            copyBtn.textContent = "Copied!";
            copyBtn.style.opacity = "0.7";

            setTimeout(() => {
                copyBtn.textContent = "Copy";
                copyBtn.style.opacity = "1";
            }, 1200);
        };

        /* DELETE button */
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "small-btn delete";
        deleteBtn.onclick = () => {
            savedItems.splice(index, 1);
            localStorage.setItem("savedItems", JSON.stringify(savedItems));
            updateSavedList();
        };

        // Add buttons inside row
        btnRow.appendChild(copyBtn);
        btnRow.appendChild(deleteBtn);

        // Attach to list item
        li.appendChild(textDiv);
        li.appendChild(btnRow);

        savedList.appendChild(li);
    });
}

</script>

</body>
</html>
